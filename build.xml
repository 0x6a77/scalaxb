<?xml version="1.0" encoding="UTF-8"?>
<project name="scalaxb" default="build">

  <property file="build.properties"/>
  <property name="scala.home" value="${user.home}/sbaz"/>
  <property name="build.dir" value="${basedir}/classes"/>
  <property name="dist.dir" value="${basedir}/dist"/>
  <property name="doc.dir" value="${basedir}/doc"/>
  <property name="test.dir" value="${basedir}/tests/tmp"/>
  <property name="scala-compiler.jar" value="${scala.home}/lib/scala-compiler.jar"/>
  <property name="scala-library.jar" value="${scala.home}/lib/scala-library.jar"/>

  <target name="init">
    <fail message="Property ${scala.home} not set">
      <condition><not><and>
        <available file="${scala-compiler.jar}"/>
        <available file="${scala-library.jar}"/>
      </and></not></condition>
    </fail>
    <taskdef resource="scala/tools/ant/antlib.xml">
      <classpath>
        <pathelement location="${scala-compiler.jar}"/>
        <pathelement location="${scala-library.jar}"/>
      </classpath>
    </taskdef>
  </target>
  
  <target name="rebuild" depends="clean,build"/>
  
  <target name="build" depends="init">
    <mkdir dir="${build.dir}"/>
    <buildnumber/>
    <scalac srcdir="src" destdir="${build.dir}" classpath="${scala-library.jar}"
        deprecation="yes" unchecked="yes"> 
      <include name="scalaxb/**/*.scala"/>
    </scalac>

    <mkdir dir="${dist.dir}/lib"/>
    <jar
      destfile="${dist.dir}/lib/scalaxb.jar"
      basedir="${build.dir}">
      <manifest>
        <attribute name="Signature-Version" value="${build.number}"/>
        <attribute name="Built-By" value="${user.name}"/>
        <attribute name="Class-Path" value="${lib.jar.name}"/>
      </manifest>
    </jar>
  </target>

  <target name="test" depends="clean,build">
    <ant antfile="tests/test.xml"/>
  </target>

  <target name="deploy" depends="dist"/>

  <target name="dist" depends="build,doc">
    <mkdir dir="${dist.dir}/bin"/>
    <scalascript
      file="${dist.dir}/bin/scalaxb"
      class="scalaxb.Main"
      javaFlags="-Xmx256M -Xms16M"
    />
    
    <mkdir dir="${dist.dir}/doc"/>
    <copy todir="${dist.dir}/doc">
      <fileset dir="${doc.dir}"/>
    </copy>

    <sbaz
      file="${dist.dir}/scalaxb-${build.number}.sbp"
      adfile="${dist.dir}/scalaxb-${build.number}.advert"
      name="scalaxb"
      version="${build.number}"
      desc="XML data binding tool for Scala.">
      <binset dir="${dist.dir}/bin" includes="*"/>      
      <docset dir="${dist.dir}/doc" includes="**"/>
      <libset dir="${dist.dir}/lib" includes="scalaxb.jar"/>
    </sbaz>
  </target>

  <target name="doc">
    <mkdir dir="${doc.dir}/scaladoc"/>
    <scaladoc
      srcdir="src" destdir="${doc.dir}/scaladoc"
      classpath="${scala-library.jar}"
      doctitle="&lt;div&gt;scalaxb&lt;/div&gt;"
    >
      <include name="scalaxb/**/*.scala"/>
    </scaladoc>
  </target>

  <target name="clean">
    <delete dir="${build.dir}"/>
    <delete dir="${doc.dir}/scaladoc/**"/>
    <delete dir="${dist.dir}"/>
    <delete dir="${test.dir}"/>
  </target>

</project>
